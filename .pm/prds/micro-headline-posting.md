# PRD: 发布微头条功能

**日期**: 2025-02-11
**版本**: 1.0
**WINNING 评分**: 49/60 🟢 FILE
**优先级**: P0 (最高)

---

## 问题陈述 (Problem Statement)

### 当前痛点
用户无法自动发布微头条参与今日头条平台活动，这是商业模式的核心收益来源。

### 业务影响
- **无法获取收益**: 平台活动奖励是主要收入来源
- **运营效率低**: 需要手动查找活动、撰写内容、发布
- **规模化受限**: 无法批量参与多个活动

### 成功定义
能够自动抓取平台活动话题，使用 AI 生成符合活动要求的微头条内容，并成功发布获取收益。

---

## 用户故事 (User Stories)

### 主要故事
```
作为自媒体运营者，
我想要自动发布微头条参与平台活动，
以便获取平台奖励收益。
```

### 详细场景

#### 场景 1: 查看活动列表
**Given** 平台有新的活动话题
**When** 我运行 `toutiao-agent activities` 命令
**Then** 显示当前所有可用活动及其要求

#### 场景 2: 生成微头条内容
**Given** 我选择了某个活动话题
**When** 活动有特定要求（如字数、话题标签）
**Then** AI 生成符合要求的微头条内容

#### 场景 3: 发布微头条
**Given** 我确认了生成的内容
**When** 执行发布命令
**Then** 微头条成功发布到我的账号

#### 场景 4: 批量参与活动
**Given** 有多个活动同时进行
**When** 我运行 `toutiao-agent start-activities --count 5`
**Then** 依次参与 5 个活动，每个活动生成并发布一条微头条

---

## 竞争分析 (Competitive Analysis)

### 竞品现状
| 产品 | 微头条发布 | AI 生成 | 活动抓取 |
|------|-----------|---------|----------|
| **Octopus RPA** | 通用 RPA 可能支持 | 集成 AI 平台 | 关键词筛选 |
| **Riona AI Agent** | 多平台支持 | ✅ 自动生成 | ❌ 无活动功能 |
| **TTBot** | ❌ 仅有评论 | ❌ 无 | ❌ 无 |

### 差异化机会
- **垂直专精**: 专注头条微头条 + 活动参与
- **活动感知**: 自动识别活动要求（话题标签、字数等）
- **内容优化**: AI 针对活动规则优化内容

---

## 功能需求 (Functional Requirements)

### P0 (必须实现)

#### FR-1: 活动列表获取
- 支持从头条活动页面抓取活动列表
- 解析活动名称、要求、截止时间
- 过滤已结束的活动

#### FR-2: 活动详情解析
- 解析活动话题标签（如 #话题名#）
- 解析活动要求（字数限制、图片要求等）
- 解析活动奖励规则

#### FR-3: AI 内容生成
- 根据活动要求生成微头条内容
- 自动添加活动话题标签
- 控制字数在规定范围内
- 支持多种风格（与评论风格一致）

#### FR-4: 微头条发布
- 通过 Playwright 发布微头条
- 支持 text 类型（纯文字）
- 支持 image 类型（文字+图片，可选 P1）
- 验证发布成功

#### FR-5: CLI 命令
```bash
# 查看活动列表
toutiao-agent activities

# 生成微头条（不发布）
toutiao-agent generate-micro-headline <activity_id>

# 发布微头条
toutiao-agent post-micro-headline <activity_id> "<content>"

# 自动流程（生成+发布）
toutiao-agent start-activities --count 5
```

### P1 (重要增强)

#### FR-6: 去重机制
- 记录已参与的活动
- 避免重复参与同一活动

#### FR-7: 存储记录
- SQLite 记录发布的微头条
- 包含活动ID、内容、发布时间、状态

#### FR-8: 交互确认模式
- confirmation_mode 控制
- 生成内容后确认再发布

#### FR-9: 图片支持
- 支持 AI 生成配图（使用 DALL-E 等）
- 支持 URL 图片上传

### P2 (未来优化)

#### FR-10: 定时发布
- 支持 cron 定时任务
- 活动开始时自动发布

#### FR-11: 效果追踪
- 追踪微头条的阅读量/互动量
- 分析哪些活动收益更高

---

## 非功能需求 (Non-Functional Requirements)

### NFR-1: 性能
- 抓取活动列表 < 5 秒
- 生成内容 < 10 秒
- 发布微头条 < 15 秒

### NFR-2: 可靠性
- 发布失败自动重试 3 次
- 失败后记录到日志
- Cookie 过期自动重新登录

### NFR-3: 可维护性
- 遵循现有代码架构
- 与评论模块共享配置
- 使用现有存储系统

### NFR-4: 安全性
- 敏感信息存储在 .env
- 不泄露活动规则漏洞
- 遵守平台使用条款

---

## 验收标准 (Acceptance Criteria)

### P0 验收

| ID | 标准 | 验证方法 |
|----|------|----------|
| AC-1 | 能获取活动列表 | 运行命令显示活动 |
| AC-2 | 能解析活动要求 | 显示活动话题、字数限制 |
| AC-3 | AI 生成符合要求的内容 | 内容包含话题标签、字数合规 |
| AC-4 | 成功发布微头条 | 发布后可在个人主页看到 |
| AC-5 | CLI 命令可用 | 所有命令正常执行 |

### P1 验收

| ID | 标准 | 验证方法 |
|----|------|----------|
| AC-6 | 不重复参与活动 | 重复运行时跳过已参与 |
| AC-7 | 记录发布历史 | history 命令显示微头条 |
| AC-8 | 确认模式生效 | 生成后询问是否发布 |

---

## 边缘情况 (Edge Cases)

| 情况 | 处理方式 |
|------|----------|
| 无活动可用 | 提示"当前无活动" |
| 活动已结束 | 过滤掉，不参与 |
| 内容生成失败 | 重试 3 次，失败则跳过 |
| 发布失败（审核拦截） | 记录失败原因，询问是否修改 |
| 网络超时 | 等待 30 秒后重试 |
| Cookie 过期 | 自动重新登录 |
| 活动要求不明确 | 使用默认配置，提示用户 |

---

## 不在范围内 (Out of Scope)

以下功能明确不在本次实现范围：

- ❌ 微头条评论回复
- ❌ 微头条数据分析
- ❌ 多账号管理
- ❌ 视频微头条
- ❌ 微头条编辑/删除
- ❌ 活动奖励查询（需要手动在平台查看）

---

## 技术考量 (Technical Considerations)

### 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                     CLI Commands                        │
│  activities | generate-micro-headline | post-micro-headline│
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  MicroHeadlineService                   │
│  ┌──────────────┐  ┌─────────────┐  ┌───────────────┐ │
│  │ActivityFetcher│  │ContentGenerator│ │MicroHeadlinePoster│
│  └──────────────┘  └─────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                   Playwright Browser                     │
│  • 访问活动页面                                          │
│  • 发布微头条                                            │
└─────────────────────────────────────────────────────────┘
```

### 关键实现点

#### 1. 活动页面解析
```python
# 需要调研的活动页面 URL
- https://www.toutiao.com/c/user/activity/  # 个人活动中心
- https://www.toutiao.com/activity/         # 活动广场
```

#### 2. 微头条发布 API
```python
# 可能的发布方式
- 通过网页表单提交（Playwright）
- 通过内部 API（需要抓包分析）
```

#### 3. 内容生成提示词
```python
# prompts/micro_headline_generation.txt
参考评论生成模板，针对微头条优化：
- 更长的内容（100-300字）
- 必须包含话题标签
- 符合活动要求的语气
```

### 数据模型

```sql
-- 新增表
CREATE TABLE micro_headlines (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    activity_id TEXT,
    activity_title TEXT,
    content TEXT,
    hashtags TEXT,
    status TEXT,  -- draft/published/failed
    created_at TEXT,
    published_at TEXT
);
```

---

## 成功指标 (Success Metrics)

| 指标 | 目标 | 测量方式 |
|------|------|----------|
| 功能完成率 | P0 100% | 验收标准通过 |
| 发布成功率 | >80% | 发布成功/总尝试 |
| 内容合规率 | >90% | 符合活动要求/总生成 |
| 命令执行时间 | <30秒 | 端到端计时 |

---

## 依赖项 (Dependencies)

| 依赖 | 状态 | 说明 |
|------|------|------|
| Playwright | ✅ 已有 | 浏览器自动化 |
| Claude API | ✅ 已有 | AI 内容生成 |
| SQLite | ✅ 已有 | 数据存储 |
| 活动页面调研 | ⏳ 待完成 | 需要实际抓取分析 |

---

## 风险与缓解 (Risks & Mitigations)

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 活动页面结构变化 | 高 | 多选择器备份，定期检查 |
| 发布接口变化 | 高 | 降级到浏览器操作 |
| 内容审核拦截 | 中 | 优化提示词，人工审核 |
| 平台规则变更 | 中 | 关注官方公告，灵活适配 |

---

## 实施计划 (Implementation Plan)

### Phase 1: 调研与设计 (1-2天)
- [ ] 调研活动页面结构
- [ ] 抓包分析发布接口
- [ ] 设计提示词模板

### Phase 2: 核心功能 (3-5天)
- [ ] 实现活动抓取
- [ ] 实现内容生成
- [ ] 实现发布功能

### Phase 3: 增强功能 (2-3天)
- [ ] 去重机制
- [ ] 存储记录
- [ ] 确认模式

### Phase 4: 测试与优化 (1-2天)
- [ ] 端到端测试
- [ ] 边缘情况处理
- [ ] 性能优化

**预计总时间**: 7-12 天

---

## 参考资料 (References)

- 产品清单: `.pm/product/inventory.md`
- 差距分析: `.pm/gaps/2025-02-11-analysis.md`
- 评论生成模板: `prompts/comment_generation.txt`
- 现有架构: `src/toutiao_agent/`

---

## GitHub Issue 标签

```
pm:feature-request
winning:high (49/60)
priority:now
scope:micro-headline
```
